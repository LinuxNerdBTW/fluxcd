properties([
  pipelineTriggers([
    pollSCM('H/2 * * * *')  // Poll every 2 mins
  ])
])

pipeline {
  agent {
    kubernetes {
      yamlFile 'clusters/prod/apps/chatbot/docker-agent.yaml'
      defaultContainer 'docker'
    }
  }

  environment {
    IMAGE_NAME = "docker.io/mangale/smart-ai"
  }

  stages {
    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/LinuxNerdBTW/fluxcd.git'
      }
    }

    stage('Set Tag') {
      steps {
        script {
          def commitId = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
          env.TAG = commitId
          echo "Using image tag: ${TAG} and latest"
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        sh """
          cd clusters/prod/apps/chatbot
          docker build -t ${IMAGE_NAME}:${TAG} -t ${IMAGE_NAME}:latest .
        """
      }
    }

    stage('Push Docker Image') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'docker.io', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
          sh """
            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
            docker push ${IMAGE_NAME}:${TAG}
            docker push ${IMAGE_NAME}:latest
          """
        }
      }
    }
  }
}
